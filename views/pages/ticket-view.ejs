<%- include("../partials/header", { title: "Ticket View" }) %>


    <% const formatDT=(d)=> {
        if (!d) return "";
        const date = new Date(d);

        const datePart = date.toLocaleDateString("en-US", {
        weekday: "short",
        month: "short",
        day: "numeric",
        year: "numeric",
        timeZone: "America/New_York",
        });

        const timePart = date.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
        timeZone: "America/New_York",
        });

        return `${datePart} ${timePart.toLowerCase()}`; //formats to Mon Dec 29 2025 12:31 pm
        };
        %>

        <% const formatMsgDT=(d)=> {
            if (!d) return "";
            const date = new Date(d);

            const datePart = date.toLocaleDateString("en-US", {
            month: "2-digit",
            day: "2-digit",
            year: "2-digit",
            timeZone: "America/New_York",
            });

            let timePart = date.toLocaleTimeString("en-US", {
            hour: "numeric",
            minute: "2-digit",
            hour12: true,
            timeZone: "America/New_York",
            });

            timePart = timePart.toLowerCase().replace(" ", ""); // "12:31pm"

            return `${datePart}, ${timePart}`; // "12/29/25, 12:31pm"
            };
            %>

            <body id="page-ticket-view" class="overflow-hidden bg-navy">
                <section class="ticket-view-shell mt-4">
                    <div class="container h-100 py-4">
                        <div class="row h-100">
                            <div class="col-lg-8 ticket-details bg-white-gray py-2">
                                <h2 class="mb-2 fw-bold">Ticket #<%= ticket.ticketNumber %> - <%=ticket.title%>
                                </h2>
                                <h3>Subject: <%= ticket.subjectLine %>
                                </h3>
                                <h4>Status: <%= ticket.status %>
                                </h4>
                                <h4>
                                    Assignee: <%= ticket.assignee %>
                                        <% if (ticket.assignee==="Unclaimed" ) { %>
                                            <form method="POST" action="/tickets/<%= ticket._id %>/claim"
                                                class="d-inline ms-2">
                                                <button type="submit" class="btn btn-success btn-sm">Claim</button>
                                            </form>
                                            <% } else if (userName && ticket.assignee===userName) { %>
                                                <span class="badge bg-success ms-2">You</span>
                                                <% } %>
                                </h4>
                                <h4>Requester: <%= ticket.requester %>
                                </h4>
                                <h4>Date Created: <%= formatDT(ticket.createdAt) %>
                                </h4>
                                <h4>Due Date: <%= formatDT(ticket.dueDate) %>
                                </h4>
                                <h4>Category: <%= ticket.category %>
                                </h4>
                                <h4>Priority: <%= ticket.priority %>
                                </h4>
                                <h4>Description: <br>
                                    <h5>
                                        <%= ticket.description %>
                                    </h5>
                                </h4>

                                </h3>
                            </div>
                            <div class="col-lg-3 offset-lg-1 msg-thread-wrapper p-2">
                                <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal"
                                    data-bs-target="#addMessage">Reply</button>

                                <div class="">
                                    <% if (ticket.messages && ticket.messages.length> 0) { %>
                                        <% ticket.messages.slice().reverse().forEach((msg)=> { %>
                                            <strong>
                                                <%= formatMsgDT(msg.createdAt) %>
                                                    <%= msg.name %>:
                                            </strong>
                                            <div class="">
                                                <%= msg.message %>
                                            </div>
                                            <hr>
                                            <% }) %>
                                                <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>


                <div id="addMessage" class="modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add message to thread</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-flex align-items-top justify-content-center">
                                    <form method="POST" action="/tickets/newMessage">
                                        <input type="hidden" name="ticketId" value="<%= ticket._id %>">

                                        <div class="mb-1">
                                            <label for="Name" class="form-label">Name: </label>
                                            <input type="text" class="form-control form-control-lg" id="Name"
                                                name="Name" placeholder="Your Name" required />
                                        </div>

                                        <div class="mb-1">
                                            <label for="message" class="form-label">Message: </label>
                                            <textarea type="text" class="form-control form-control-lg" id="message"
                                                name="message" placeholder="Your Message" required></textarea>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                Submit Reply
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
                    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
                    crossorigin="anonymous"></script>

            </body>

            </html>